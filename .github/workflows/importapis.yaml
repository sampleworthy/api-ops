name: Import APIs to APIM

on:
  push:
    branches:
      - main

jobs:
  import-apis:
    runs-on: ubuntu-latest
    name: Import APIs

    steps:
      - uses: actions/checkout@v2

      - name: Install yq
        run: |
          sudo add-apt-repository ppa:rmescandon/yq
          sudo apt update
          sudo apt install yq -y

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Import APIs
        run: |
          for file in ./apis/*.yaml; do
            baseName=$(basename "$file" .yaml)
            serviceUrl=$(yq e '.servers[0].url' $file)
            versionId=$(yq e '.info.version' $file)
            displayName="$baseName-$versionId"
            az apim api version set --api-id $baseName --version-id $versionId --description "Version $versionId" --versioning-scheme Path
            az apim api import --resource-group ${{ secrets.RESOURCE_GROUP }} --service-name ${{ secrets.APIM_INSTANCE }} --api-id $baseName --api-version $versionId --display-name $displayName --service-url $serviceUrl --protocols https --specification-format OpenApi --specification-path $file
          done
